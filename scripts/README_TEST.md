# Комплексное тестирование бота

## Описание

Скрипт `comprehensive_test.py` выполняет комплексное тестирование всех функций бота на одной тестовой группе.

## Что тестируется

1. **Создание группы** - создание тестовой группы с настройками
2. **Настройка слотов** - настройка временных слотов для группы
3. **Ручное создание опроса** - создание опроса через API
4. **Проверка существующих опросов** - проверка отправки существующих опросов
5. **Принудительное создание опроса** - пересоздание опроса с закрытием существующего
6. **Закрытие опроса** - закрытие опроса с созданием скриншота результатов
7. **Проверка расписания** - проверка настроек автоматического расписания
8. **Повторное создание** - проверка, что опрос не создается повторно, если уже существует

## Запуск тестов

### Предварительные требования

1. Убедитесь, что база данных запущена:
```bash
docker-compose up -d
```

2. Убедитесь, что Redis запущен (в docker-compose)

3. Убедитесь, что `.env` файл настроен правильно

### Запуск

```bash
# Активируйте виртуальное окружение
source venv/bin/activate

# Запустите тесты
python scripts/comprehensive_test.py
```

## Тестовые данные

Скрипт использует следующие тестовые данные:
- **Название группы**: `ТЕСТ-ГРУППА`
- **Chat ID**: `-1000000000000`
- **Topic ID**: `123`
- **Слоты**: 
  - `07:30-19:30` (лимит 3)
  - `08:00-20:00` (лимит 2)

## Очистка после тестов

После завершения тестов можно удалить тестовую группу:

```bash
python scripts/delete_test_group.py
```

## Важные замечания

1. **Реальные Telegram API вызовы**: Скрипт делает реальные вызовы к Telegram API. Убедитесь, что:
   - Бот добавлен в тестовую группу с chat_id `-1000000000000`
   - У бота есть права администратора в группе
   - Topic ID `123` существует в группе

2. **База данных**: Тесты создают реальные записи в базе данных. После тестов рекомендуется удалить тестовую группу.

3. **Скриншоты**: Для создания скриншотов требуется Playwright. Если Playwright не установлен, тесты будут использовать текстовые отчеты.

## Результаты

После выполнения тестов вы увидите:
- Детальные логи каждого теста
- Статус прохождения каждого теста (✅ PASSED / ❌ FAILED)
- Итоговую статистику

## Устранение проблем

### Ошибка "Chat not found"
- Убедитесь, что бот добавлен в группу с указанным chat_id
- Проверьте, что chat_id правильный (для групп обычно начинается с `-100`)

### Ошибка "Topic not found"
- Убедитесь, что тема с указанным topic_id существует в группе
- Проверьте, что бот имеет доступ к теме

### Ошибка создания скриншота
- Установите Playwright: `playwright install chromium`
- Проверьте, что браузер может быть запущен (на сервере может потребоваться headless режим)


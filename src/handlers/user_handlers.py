from aiogram import Router
from aiogram.filters import Command
from aiogram.types import Message

from config.settings import settings
from src.services.user_service import UserService
from src.utils.auth import is_curator


router = Router()


# –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª—è—Ö
__all__ = ["get_user_commands", "get_admin_commands"]


def get_user_commands() -> str:
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∫–æ–º–∞–Ω–¥."""
    return """üìã <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã:</b>

üöÄ <b>/start</b> - –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ)
‚ùì <b>/help</b> - –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω—É—é —Å–ø—Ä–∞–≤–∫—É –ø–æ –≤—Å–µ–º –∫–æ–º–∞–Ω–¥–∞–º
üìä <b>/my_votes</b> - –ü—Ä–æ—Å–º–æ—Ç—Ä –º–æ–∏—Ö –≥–æ–ª–æ—Å–æ–≤ –≤ –æ–ø—Ä–æ—Å–∞—Ö
üìÖ <b>/schedule</b> - –ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è —Å–º–µ–Ω

üí° <b>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</b>
‚Ä¢ –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –±–æ—Ç –∑–∞–ø—Ä–æ—Å–∏—Ç –≤–∞—à–µ –∏–º—è –∏ —Ñ–∞–º–∏–ª–∏—é
‚Ä¢ –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 09:00 –±–æ—Ç —Å–æ–∑–¥–∞–µ—Ç –æ–ø—Ä–æ—Å—ã –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å
‚Ä¢ –ì–æ–ª–æ—Å—É–π—Ç–µ –≤ –æ–ø—Ä–æ—Å–∞—Ö –¥–æ 19:00
‚Ä¢ –í 19:00 –æ–ø—Ä–æ—Å—ã –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –≤ —Ç–µ–º—É "–ø—Ä–∏—Ö–æ–¥/—É—Ö–æ–¥"
‚Ä¢ –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –∑–∞–∫—Ä—ã—Ç–∏–∏ –∑–∞–ø–∏—Å–∏ (14:00-18:00)"""


def get_admin_commands() -> str:
    """–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω—Å–∫–∏—Ö –∫–æ–º–∞–Ω–¥."""
    return """üëë <b>–ê–¥–º–∏–Ω—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã:</b>

üéõÔ∏è <b>/admin</b> - <b>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Å –∫–Ω–æ–ø–∫–∞–º–∏</b> (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è!)
   –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º —á–µ—Ä–µ–∑ —É–¥–æ–±–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:
   ‚Ä¢ ‚ûï –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É –¥–ª—è –ó–ò–ó
   ‚Ä¢ ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–ª–æ—Ç–æ–≤ (—Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏)
   ‚Ä¢ ‚è∞ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
   ‚Ä¢ üìå –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–º—É (3 —Ç–∏–ø–∞ —Ç–µ–º)
   ‚Ä¢ üìù –°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å—ã –≤—Ä—É—á–Ω—É—é
   ‚Ä¢ üìä –í—ã–≤–µ—Å—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
   ‚Ä¢ üîí –î–æ—Å—Ä–æ—á–Ω–æ –∑–∞–∫—Ä—ã—Ç—å –æ–ø—Ä–æ—Å

üìù <b>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏:</b>
‚ûï <b>/add_group</b> - –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –≥—Ä—É–ø–ø—É
   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /add_group –Ω–∞–∑–≤–∞–Ω–∏–µ chat_id [topic_id]
   –ü—Ä–∏–º–µ—Ä: /add_group –ó–ò–ó-1 -1001234567890 123

‚öôÔ∏è <b>/setup_ziz</b> - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–ª–æ—Ç—ã –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –≥—Ä—É–ø–ø—ã
   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /setup_ziz –ó–ò–ó-1
   üí° –£ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã –º–æ–≥—É—Ç –±—ã—Ç—å —Ä–∞–∑–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–ª–æ—Ç–æ–≤!

üìã <b>/list_groups</b> - –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –≥—Ä—É–ø–ø

üìå <b>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–º:</b>
üìå <b>/set_topic</b> - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–º—É "–æ—Ç–º–µ—Ç–∫–∏ –Ω–∞ —Å–ª–æ—Ç"
üì• <b>/set_arrival_topic</b> - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–º—É "–ø—Ä–∏—Ö–æ–¥/—É—Ö–æ–¥"
üí¨ <b>/set_general_topic</b> - –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–º—É "–æ–±—â–∏–π —á–∞—Ç"
üîç <b>/get_topic_id</b> - –ü–æ–∫–∞–∑–∞—Ç—å topic_id –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

üìä <b>–û–ø—Ä–æ—Å—ã –∏ –æ—Ç—á–µ—Ç—ã:</b>
üìù <b>/create_polls</b> - –°–æ–∑–¥–∞—Ç—å –æ–ø—Ä–æ—Å—ã –≤—Ä—É—á–Ω—É—é
üìÑ <b>/get_report</b> - –ü–æ–ª—É—á–∏—Ç—å –æ—Ç—á–µ—Ç –ø–æ –≥—Ä—É–ø–ø–µ
   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /get_report –ó–ò–ó-1 [–¥–∞—Ç–∞ –î–î.–ú–ú.–ì–ì–ì–ì]

üìà <b>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:</b>
üìä <b>/stats</b> - –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–∏—Å—Ç–µ–º—ã
üîç <b>/status</b> - –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã (CPU, RAM, Disk)
üìú <b>/logs</b> - –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ —Å–∏—Å—Ç–µ–º—ã

üí° <b>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:</b> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ <b>/admin</b> –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫–∏!"""


@router.message(Command("help"))
async def cmd_help(message: Message) -> None:
    """–ü–æ–º–æ—â—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é."""
    user_id = message.from_user.id
    is_admin = user_id in settings.ADMIN_IDS
    
    help_text = (
        "‚ÑπÔ∏è <b>–°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º –±–æ—Ç–∞</b>\n\n"
        f"{get_user_commands()}\n\n"
    )
    
    if is_admin:
        help_text += f"{get_admin_commands()}\n\n"
    
    help_text += (
        "‚è∞ <b>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–±–æ—á–∏–π —Ü–∏–∫–ª:</b>\n"
        "‚Ä¢ <b>09:00</b> - –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Ç–µ–º—ã '–æ—Ç–º–µ—Ç–∫–∏ –Ω–∞ —Å–ª–æ—Ç' –∏ –æ–ø—Ä–æ—Å–æ–≤ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å\n"
        "‚Ä¢ <b>14:00-18:00</b> - –ï–∂–µ—á–∞—Å–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –∑–∞–∫—Ä—ã—Ç–∏–∏ –∑–∞–ø–∏—Å–∏\n"
        "‚Ä¢ <b>18:30</b> - –§–∏–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ (30 –º–∏–Ω—É—Ç –¥–æ –∑–∞–∫—Ä—ã—Ç–∏—è)\n"
        "‚Ä¢ <b>19:00</b> - –ó–∞–∫—Ä—ã—Ç–∏–µ –æ–ø—Ä–æ—Å–æ–≤, —Å–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤, –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ —Ç–µ–º—É '–ø—Ä–∏—Ö–æ–¥/—É—Ö–æ–¥'\n\n"
    )
    
    if is_admin:
        help_text += (
            "üéõÔ∏è <b>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å:</b>\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É <b>/admin</b> –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º\n"
            "—á–µ—Ä–µ–∑ —É–¥–æ–±–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –∫–Ω–æ–ø–∫–∞–º–∏. –≠—Ç–æ —Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–æ–º!\n\n"
        )
    
    help_text += (
        "üí° <b>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</b>\n"
        "–î–ª—è —É—á–∞—Å—Ç–∏—è –≤ –æ–ø—Ä–æ—Å–∞—Ö –ø—Ä–æ—Å—Ç–æ –≥–æ–ª–æ—Å—É–π—Ç–µ –≤ –æ–ø—Ä–æ—Å–∞—Ö,\n"
        "–∫–æ—Ç–æ—Ä—ã–µ –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ –≤–∞—à–∏ –≥—Ä—É–ø–ø—ã.\n\n"
        "–ö–∞–∂–¥–∞—è –≥—Ä—É–ø–ø–∞ –ó–ò–ó –∏–º–µ–µ—Ç —Å–≤–æ–∏ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–ª–æ—Ç–æ–≤ –≤—Ä–µ–º–µ–Ω–∏."
    )
    
    await message.answer(help_text)


@router.message(Command("my_votes"))
async def cmd_my_votes(
    message: Message,
    user_service: UserService | None = None,
) -> None:
    """–ü—Ä–æ—Å–º–æ—Ç—Ä –º–æ–∏—Ö –≥–æ–ª–æ—Å–æ–≤."""
    if not user_service:
        await message.answer("‚ùå –û—à–∏–±–∫–∞: —Å–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
        return
    
    user_id = message.from_user.id
    user = message.from_user
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫—É—Ä–∞—Ç–æ—Ä–æ–º
    user_is_curator = is_curator(user)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∞ –≤–∫–ª—é—á–µ–Ω–∞ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∫—É—Ä–∞—Ç–æ—Ä
    if settings.ENABLE_VERIFICATION and not user_is_curator:
        is_verified = await user_service.is_verified(user_id)
        
        if not is_verified:
            await message.answer(
                "‚ùå –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤–∞—à–∏—Ö –≥–æ–ª–æ—Å–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–π—Ç–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é.\n\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /start –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã."
            )
            return
    
    # TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –≥–æ–ª–æ—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    await message.answer("üó≥Ô∏è –§—É–Ω–∫—Ü–∏—è /my_votes –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–∑–∂–µ.")


@router.message(Command("schedule"))
async def cmd_schedule(
    message: Message,
    user_service: UserService | None = None,
) -> None:
    """–ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è."""
    if not user_service:
        await message.answer("‚ùå –û—à–∏–±–∫–∞: —Å–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω")
        return
    
    user_id = message.from_user.id
    user = message.from_user
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫—É—Ä–∞—Ç–æ—Ä–æ–º
    user_is_curator = is_curator(user)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∞ –≤–∫–ª—é—á–µ–Ω–∞ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∫—É—Ä–∞—Ç–æ—Ä
    if settings.ENABLE_VERIFICATION and not user_is_curator:
        is_verified = await user_service.is_verified(user_id)
        
        if not is_verified:
            await message.answer(
                "‚ùå –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–π—Ç–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é.\n\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /start –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã."
            )
            return
    
    # TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    await message.answer("üìÖ –§—É–Ω–∫—Ü–∏—è /schedule –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–∑–∂–µ.")



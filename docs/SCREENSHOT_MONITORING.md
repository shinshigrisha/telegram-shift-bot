# Мониторинг скриншотов в теме "приход/уход"

## Описание

Бот автоматически отслеживает скриншоты, которые курьеры отправляют в тему "приход/уход" из мобильного приложения (где они встали в очередь). Если в течение 20 минут не было ни одного скриншота, бот проверяет все группы и тэгает кураторов.

## Как это работает

### 1. Отслеживание скриншотов

Бот автоматически отслеживает все сообщения с фото или документами в теме "приход/уход" (`arrival_departure_topic_id`):

- ✅ **Фото** - любые изображения, отправленные в тему
- ✅ **Документы** - файлы (включая скриншоты как документы)
- ✅ **Автоматическая запись времени** - время каждого скриншота сохраняется в базе данных

### 2. Проверка каждые 20 минут

Бот автоматически проверяет все активные группы:
- **Время проверки**: каждые 20 минут (в 0, 20, 40 минут каждого часа)
- **Проверка**: есть ли скриншоты за последние 20 минут
- **Действие**: если скриншотов нет - тэгает кураторов

### 3. Уведомление кураторов

Если в группе не было скриншотов более 20 минут, бот отправляет сообщение в тему "приход/уход":

```
⚠️ Внимание кураторам!

В группе ЗИЗ-1 не было скриншотов в теме 'приход/уход' в течение последних 20 минут.

Пожалуйста, проверьте, все ли курьеры отправили скриншоты из мобильного приложения.

[Куратор 1] [Куратор 2] [Куратор 3]
```

## Кураторы

Бот автоматически определяет кураторов по их username:

- `Korolev_Nikita_20`
- `Kuznetsova_Olyaa`
- `Evgeniy_kuznetsoof`
- `VV_Team_Mascot`

Кураторы определяются из списка администраторов группы.

## Настройка

### Интервал проверки

По умолчанию проверка происходит каждые 20 минут. Интервал можно изменить в файле `src/services/scheduler_service.py`:

```python
# Проверка скриншотов каждые 20 минут (в 0, 20, 40 минут каждого часа)
for minute in [0, 20, 40]:
    self.scheduler.add_job(
        self._check_screenshots_job,
        CronTrigger(minute=minute),
        id=f"check_screenshots_{minute}",
    )
```

### Добавление кураторов

Кураторы определяются в методе `get_curators_for_group` файла `src/services/screenshot_monitor_service.py`:

```python
curator_usernames = [
    "Korolev_Nikita_20",
    "Kuznetsova_Olyaa",
    "Evgeniy_kuznetsoof",
    "VV_Team_Mascot",
]
```

## База данных

Время последнего скриншота хранится в таблице `screenshot_checks`:

- `group_id` - ID группы
- `last_screenshot_time` - время последнего скриншота
- `created_at` - время создания записи
- `updated_at` - время последнего обновления

## Миграция базы данных

Для создания таблицы выполните:

```bash
docker exec shift-bot-postgres psql -U bot_user -d shift_bot -c "CREATE TABLE IF NOT EXISTS screenshot_checks (id SERIAL PRIMARY KEY, group_id INTEGER NOT NULL UNIQUE REFERENCES groups(id) ON DELETE CASCADE, last_screenshot_time TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP, created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP, updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP); CREATE INDEX IF NOT EXISTS idx_screenshot_checks_group_id ON screenshot_checks(group_id);"
```

Или скопируйте SQL-скрипт в контейнер и выполните:

```bash
# Скопировать файл в контейнер
docker cp scripts/create_screenshot_checks_table.sql shift-bot-postgres:/tmp/

# Выполнить SQL-скрипт
docker exec shift-bot-postgres psql -U bot_user -d shift_bot -f /tmp/create_screenshot_checks_table.sql
```

## Логирование

Все действия логируются:

- `INFO` - успешная запись скриншота
- `WARNING` - группа без скриншотов
- `ERROR` - ошибки при проверке или отправке уведомлений

Логи можно просмотреть через команду `/logs` в админ-панели или в файлах логов.

## Примеры работы

### Пример 1: Скриншот отправлен

1. Курьер отправляет скриншот в тему "приход/уход"
2. Бот автоматически записывает время скриншота
3. В логах: `Recorded screenshot in group ЗИЗ-1 (topic 123) from user 456789`

### Пример 2: Скриншотов нет более 20 минут

1. Бот проверяет все группы в 10:20
2. Обнаруживает, что в группе ЗИЗ-1 последний скриншот был в 10:00
3. Отправляет уведомление кураторам в тему "приход/уход"
4. В логах: `Notified curators for group ЗИЗ-1`

### Пример 3: Все группы имеют скриншоты

1. Бот проверяет все группы в 14:40
2. Все группы имеют скриншоты за последние 20 минут
3. Уведомления не отправляются
4. В логах: `All groups have recent screenshots`

## Важные замечания

1. **Тема "приход/уход" обязательна**: Бот работает только с группами, у которых настроена тема "приход/уход" (`arrival_departure_topic_id`)

2. **Только фото и документы**: Бот отслеживает только сообщения с фото или документами. Текстовые сообщения игнорируются.

3. **Только в теме**: Бот отслеживает скриншоты только в теме "приход/уход". Скриншоты в других темах или общем чате не учитываются.

4. **Автоматическое определение кураторов**: Бот автоматически определяет кураторов из списка администраторов группы по их username.

5. **Тэгание через user_id**: Кураторы тэгаются через `user_id`, что гарантирует доставку уведомления даже если у куратора нет username.

